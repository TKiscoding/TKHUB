<!-- TKHUB with Google Login + Email Verification + Cookies -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TKHUB - Stream Anything</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- Login View -->
  <div class="login-container" id="loginView">
    <h2>Welcome to TKHUB</h2>
    <div id="g_id_onload"
         data-client_id="777130092676-dbtq911vnl7j8c08511ru29qa6jvqelj.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"
         data-ux_mode="popup">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <p id="loginError" style="color: red; margin-top: 1rem;"></p>
  </div>

  <!-- App View -->
  <div class="app-container" id="appView" style="display: none;">
    <header>
      <h1>TKHUB</h1>
      <span id="userInfo"></span>
    </header>

    <div class="video-card">
      <h2>Featured Video</h2>
      <p>
        Enjoy this featured video stream on TKHUB.
      </p>
      <div class="stream-output" id="streamOutput">
        <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/DIsST2E_4-4?si=BV3r6SAdsDxmvpu4" 
          title="YouTube video player" frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
        </iframe>
      </div>
    </div>

    <div class="settings">
      <h3>User Settings</h3>
      <label>Email: <span id="settingsEmail"></span></label>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    // Cookie helpers
    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
    }

    function getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r
      }, null);
    }

    function eraseCookie(name) {
      document.cookie = name + '=; Max-Age=0; path=/';
    }

    // JWT Parser
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));

        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('Invalid JWT:', e);
        return null;
      }
    }

    // Google login callback
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);

      if (!data.email_verified) {
        document.getElementById("loginError").textContent = "Only verified Google accounts are allowed.";
        return;
      }

      setCookie('email', data.email, 7);
      setCookie('name', data.name, 7);
      setCookie('picture', data.picture, 7);
      showApp(data.email, data.name, data.picture);
    }

    function showApp(email, name, picture) {
      document.getElementById("loginView").style.display = "none";
      document.getElementById("appView").style.display = "block";

      document.getElementById("userInfo").innerHTML = `
        <img src="${picture}" alt="User Avatar" />
        <span>${name}</span>
      `;
      document.getElementById("settingsEmail").textContent = email;
    }

    function logout() {
      eraseCookie('email');
      eraseCookie('name');
      eraseCookie('picture');
      location.reload();
    }

    // Auto-login if cookie exists
    window.onload = () => {
      const email = getCookie('email');
      const name = getCookie('name');
      const picture = getCookie('picture');

      if (email && name && picture) {
        showApp(email, name, picture);
      }
    };
  </script>
</body>
</html>
